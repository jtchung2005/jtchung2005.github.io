<!-- 載入 Tailwind CSS CDN (必須保留) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- 嵌入式樣式，確保 RWD 與視覺效果 -->
<style>
    :root {
        font-family: 'Inter', 'Noto Sans TC', "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    
    #wordpress-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 1rem;
        background-color: #f3f4f6;
        margin: 0;
        width: 100%;
    }

    .dashboard-container {
        margin: auto;
        display: flex;
        flex-direction: column;
        max-width: 95vw; 
        width: 100%;
    }

    .checkin-button {
        width: 90px;
        height: 90px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0.3rem;
        font-size: 0.9rem;
        line-height: 1.1;
        flex-shrink: 0;
    }
    
    /* === 修正: 移除瀏覽器預設焦點環 (黑邊框) === */
    .checkin-button:focus,
    .checkin-button:focus-visible {
        outline: none; 
        /* 確保移除所有殘餘的邊框或陰影 */
        box-shadow: none;
    }
    /* 重新為活躍按鈕在聚焦時加上預期的陰影效果 */
    .checkin-button.active:focus,
    .checkin-button.active:focus-visible {
        box-shadow: 0 6px 16px 0 rgba(255, 220, 53, 0.8);
    }
    /* ========================================= */

    .checkin-button.active {
        background: linear-gradient(135deg, #FFDC35 0%, #FFC700 100%);
        color: #333;
        box-shadow: 0 4px 14px 0 rgba(255, 220, 53, 0.6);
        cursor: pointer;
        transition: transform 0.1s, box-shadow 0.3s;
    }

    .checkin-button.inactive {
        background: #4b5563;
        color: #fff;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2);
        cursor: pointer;
        opacity: 0.6;
        transition: transform 0.1s, opacity 0.3s;
    }

    .checkin-button.inactive:hover {
        opacity: 0.8;
        transform: translateY(-2px);
    }
    .checkin-button.active:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px 0 rgba(255, 220, 53, 0.8); 
    }
    
    #splashScreen {
        background-image: url('https://placehold.co/1000x300/222244/ffffff?text=Life+Habits+Dashboard'); 
        background-size: cover; 
        background-position: center; 
        background-repeat: no-repeat;
    }

    /* 遊戲結束狀態的特殊樣式 */
    /* 移除 HTML 上的 hidden class，讓 JS 完全控制 display 屬性 */
    .game-over-overlay {
        z-index: 20;
        background-color: rgba(0, 0, 0, 0.65); /* 半透明深色背景 */
        backdrop-filter: blur(5px);
        display: flex; /* 預設使用 flex，由 JS 設為 none 隱藏 */
        align-items: center;
        justify-content: center;
    }
    /* 遊戲結束時所有按鈕變灰且不可點擊 */
    .checkin-button.disabled {
        background: #9ca3af !important; /* 淺灰色 */
        color: #fff;
        cursor: not-allowed;
        opacity: 0.4;
        box-shadow: none !important;
        transform: none !important;
    }
</style>

<!-- 將原來的 body 內容包裹在一個自訂的 div 中，以確保全螢幕效果在 WordPress 內保持一致 -->
<div id="wordpress-wrapper" class="bg-gray-100 flex items-center justify-center p-4 sm:p-6">

    <!-- 主要互動面板容器 -->
    <div id="dashboard" class="max-w-[1152px] w-full dashboard-container bg-white rounded-xl shadow-2xl relative p-6">
        
        <!-- 返回主頁 (Undo/Reset) 按鈕 - 位於右上角 -->
        <button id="backToHomeButton" class="absolute top-4 right-4 text-gray-500 hover:text-red-600 transition duration-150 p-2 rounded-full bg-white/50 hover:bg-white shadow-lg z-50" title="返回主頁 / 重置">
            <!-- Undo/Reset Icon (Lucide Rotate Ccw) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.76 2.75L3 12zm0 0h3"/>
            </svg>
        </button>

        <!-- 遊戲開始前的歡迎頁面 -->
        <!-- 移除 HTML 上的 hidden class，讓 JS 完全控制 display 屬性 -->
        <div id="splashScreen" 
             class="absolute inset-0 rounded-xl z-40 flex items-end justify-center p-8">
            
            <!-- 按鈕置底且透明化 -->
            <div class="text-center"> 
                <button id="startButton" class="px-10 py-4 bg-white/20 hover:bg-white/40 text-white font-bold text-2xl rounded-lg shadow-lg transition duration-200 transform hover:scale-105 backdrop-blur-sm border border-white/50">
                    開始
                </button>
            </div>
        </div>

        <!-- 遊戲結束遮罩 (重新加入) -->
        <!-- 移除 HTML 上的 hidden class，讓 JS 完全控制 display 屬性 -->
        <div id="gameOverOverlay" class="game-over-overlay absolute inset-0 rounded-xl">
            <div class="text-center p-8 bg-gray-900/90 rounded-xl border border-red-500 shadow-2xl">
                <h2 class="text-4xl font-extrabold text-red-500 mb-4">App都未簽到</h2>
                <p class="text-xl text-gray-300 mb-6">人生分數歸零，自我價值歸零?</p>
                <button id="restartButton" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-200">
                    重新開始
                </button>
            </div>
        </div>
        <!-- 遊戲結束遮罩結束 -->

        <!-- 提示框 (絕對定位在 dashboard 內) -->
        <div id="clickHint" class="absolute bg-yellow-400 text-gray-800 p-3 rounded-lg shadow-xl hidden z-30 pointer-events-none transition duration-300" style="min-width: 150px;">
            <div class="font-bold">點擊簽到</div>
            <div class="text-sm mt-1">增加分數！</div>
            <!-- 小箭頭 -->
            <div class="w-3 h-3 bg-yellow-400 transform rotate-45 absolute bottom-[-6px] left-1/2 -translate-x-1/2"></div>
        </div>


        <!-- 標題 -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">小庭的人生分數</h1>
            <p class="text-center text-gray-500">點擊變暗的任務完成每日簽到！</p>
        </header>
        
        <!-- 加速警告區域 (使用 opacity-0 預留空間，防止佈局偏移) -->
        <div id="accelerationMessage" class="text-center p-2 mb-4 bg-red-100 border border-red-400 text-red-700 font-extrabold rounded-lg shadow-md opacity-0 pointer-events-none transition duration-300 min-h-10 flex items-center justify-center">
            <!-- 訊息將透過 JS 插入 -->
        </div>

        <!-- 進度條區塊 -->
        <section class="mb-3">
            <div class="flex justify-between items-center mb-2">
                <!-- 調整後的標題和分數顯示佈局 -->
                <h2 class="text-xl font-semibold text-gray-700">人生分數</h2>
                <!-- 分數顯示 -->
                <span id="scoreDisplay" class="text-2xl font-extrabold text-indigo-600">100分</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-8 shadow-inner">
                <div id="progressBar" class="h-8 rounded-full transition-all duration-500 ease-out" style="width: 100%; background-color: #4f46e5;">
                </div>
            </div>
        </section>

        <!-- 打卡按鈕區塊 (7 個按鈕) -->
        <section id="habitButtonsContainer" class="py-6 flex flex-wrap justify-center gap-4">
            
            <!-- 按鈕模板 (已修改為圓形) -->
            <button id="btn-lang" data-habit="學語言" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                學語言
            </button>
            <button id="btn-study" data-habit="專注學習3小時" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                專注學習3小時
            </button>
            <button id="btn-budget" data-habit="記帳" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                記帳
            </button>
            <button id="btn-calorie" data-habit="卡路里" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                計算卡路里
            </button>
            <button id="btn-diary" data-habit="寫日記" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                寫日記
            </button>
            <button id="btn-run" data-habit="跑步30分鐘" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                跑步30分鐘
            </button>
            <button id="btn-sleep" data-habit="睡滿8小時" class="checkin-button active text-white font-bold shadow-md transition transform duration-300">
                睡滿8小時
            </button>
        </section>

        <!-- 遊戲訊息提示 (已清空) -->
        <footer class="text-center text-sm text-gray-500">
            <!-- 頁尾已清空，確保內容不被壓縮 -->
        </footer>

    </div>
</div>

<!-- 嵌入式 JavaScript 邏輯 (狀態驅動重構) -->
<script>
    // --- 遊戲設定 ---
    const INITIAL_SCORE = 100;
    const SCORE_PENALTY_AMOUNT = 15;
    const BASE_RECOVER_AMOUNT = 10;
    const BONUS_RECOVER_AMOUNT = 20;
    const SCORE_DECAY_RATE = 1;
    const DECAY_INTERVAL_MS = 1000;
    const DARKEN_INTERVAL_SLOW_MS = 2000;
    const DARKEN_INTERVAL_FAST_MS = 500;
    const ACCELERATION_TIME_MS = 15000;
    const BONUS_RECOVER_TIME_MS = 20000;
    const CHANCE_TO_DARKEN_TWO = 0.3; 

    // --- 習慣定義 ---
    const habitDefinitions = {
        'btn-lang': { id: 'btn-lang', name: '學語言', element: null },
        'btn-study': { id: 'btn-study', name: '專注學習3小時', element: null },
        'btn-budget': { id: 'btn-budget', name: '記帳', element: null },
        'btn-calorie': { id: 'btn-calorie', name: '卡路里', element: null },
        'btn-diary': { id: 'btn-diary', name: '寫日記', element: null },
        'btn-run': { id: 'btn-run', name: '跑步30分鐘', element: null },
        'btn-sleep': { id: 'btn-sleep', name: '睡滿8小時', element: null },
    };

    // --- 狀態初始化 ---
    let gameState = {};
    let timers = { gameLoopInterval: null, darkenInterval: null, accelerationTimeout: null };
    let UI = {};

    function resetGameState() {
        gameState = {
            score: INITIAL_SCORE,
            isGameOver: false, 
            isGameRunning: false, 
            isFirstDarkening: true,
            gameStartTime: 0,
            habits: Object.keys(habitDefinitions).reduce((acc, key) => {
                acc[key] = { ...habitDefinitions[key], active: true };
                return acc;
            }, {}),
        };
    }
    
    // --- 核心渲染與邏輯 ---

    /** 根據當前 gameState 更新所有 UI 元素 */
    function render() {
        // 1. 分數和進度條 (分數最低為 0)
        gameState.score = Math.max(0, Math.min(100, gameState.score));
        UI.scoreDisplay.textContent = `${Math.round(gameState.score)}分`;
        UI.progressBar.style.width = `${gameState.score}%`;

        let color;
        if (gameState.score > 70) { color = '#4f46e5'; } 
        else if (gameState.score > 30) { color = '#f59e0b'; } 
        else { color = '#ef4444'; }
        UI.progressBar.style.backgroundColor = color;
        
        // 2. 按鈕狀態與事件綁定
        UI.checkinButtons.forEach(button => {
            const habitId = button.id;
            const habitState = gameState.habits[habitId];

            if (!habitState) return;
            button.classList.remove('active', 'inactive', 'disabled');

            if (gameState.isGameOver) {
                // 遊戲結束時禁用所有按鈕
                button.classList.add('disabled');
                button.onclick = null;
            } else if (habitState.active) {
                button.classList.add('active');
                button.onclick = null; 
            } else {
                button.classList.add('inactive');
                button.onclick = () => handleHabitClick(habitId);
            }
        });

        // 3. 畫面顯示控制 (splash vs. game vs. game over)
        const isRunning = gameState.isGameRunning;
        const isOver = gameState.isGameOver;

        // 【修正】使用 style.display 進行隱藏控制
        // 控制歡迎頁面 (顯示: 只有當 isRunning=false 且 isOver=false)
        UI.splashScreen.style.display = (!isRunning && !isOver) ? 'flex' : 'none';
        
        // 控制遊戲結束遮罩 (顯示: 只有當 isOver=true)
        UI.gameOverOverlay.style.display = isOver ? 'flex' : 'none'; 
        
        // 控制返回按鈕 (顯示: 只有當 isRunning=true)
        UI.backToHomeButton.classList.toggle('hidden', !isRunning);


        // 4. 檢查遊戲是否結束
        if (gameState.score <= 0 && !isOver && isRunning) {
            endGame();
        }
    }

    /** 處理隨時間持續扣分 (遊戲迴圈) */
    function gameLoop() {
        if (!gameState.isGameRunning) return;

        const inactiveHabits = Object.values(gameState.habits).filter(h => !h.active).length;
        const totalDecay = inactiveHabits * SCORE_DECAY_RATE;
        
        gameState.score -= totalDecay;
        render();
    }

    /** 將一個習慣設為非活躍並扣分 */
    function darkenSingleHabit(habitId) {
        const habit = gameState.habits[habitId];
        if (!habit || !habit.active || !gameState.isGameRunning) return;

        habit.active = false;
        gameState.score -= SCORE_PENALTY_AMOUNT; 

        if (gameState.isFirstDarkening) {
            gameState.isFirstDarkening = false;
            showClickHint(habit.element);
        }
        render();
    }

    /** 隨機將一個或兩個活躍習慣變暗 */
    function randomlyDarkenHabit() {
        if (!gameState.isGameRunning) return;
        
        let activeHabitKeys = Object.keys(gameState.habits).filter(key => gameState.habits[key].active);
        if (activeHabitKeys.length === 0) return;
        
        const randomKey1 = activeHabitKeys[Math.floor(Math.random() * activeHabitKeys.length)];
        darkenSingleHabit(randomKey1);
        
        activeHabitKeys = activeHabitKeys.filter(key => key !== randomKey1);
        
        if (activeHabitKeys.length > 0 && Math.random() < CHANCE_TO_DARKEN_TWO) {
            const randomKey2 = activeHabitKeys[Math.floor(Math.random() * activeHabitKeys.length)];
            darkenSingleHabit(randomKey2);
        }
    }

    /** 處理按鈕點擊事件 (恢復習慣) */
    function handleHabitClick(habitId) {
        if (!gameState.isGameRunning) return;
        
        const habit = gameState.habits[habitId];
        if (!habit.active) {
            const elapsedTime = Date.now() - gameState.gameStartTime;
            const recoverAmount = (elapsedTime < BONUS_RECOVER_TIME_MS) ? BONUS_RECOVER_AMOUNT : BASE_RECOVER_AMOUNT;

            habit.active = true;
            gameState.score += recoverAmount;
            UI.clickHint.classList.add('hidden');
            render();
        }
    }

    /** 加快遊戲節奏 (15 秒後觸發) */
    function accelerateGame() {
        if (!gameState.isGameRunning) return;

        if (timers.darkenInterval) clearInterval(timers.darkenInterval);
        timers.darkenInterval = setInterval(randomlyDarkenHabit, DARKEN_INTERVAL_FAST_MS);

        UI.accelerationMessage.textContent = "歐買尬，小庭進入進入繁忙的期中考週！！";
        UI.accelerationMessage.classList.remove('opacity-0', 'pointer-events-none'); 

        setTimeout(() => {
            UI.accelerationMessage.classList.add('opacity-0', 'pointer-events-none'); 
        }, 5000); 
    }

    /** 停止所有計時器 */
    function clearTimers() {
        if (timers.darkenInterval !== null) clearInterval(timers.darkenInterval);
        if (timers.gameLoopInterval !== null) clearInterval(timers.gameLoopInterval); 
        if (timers.accelerationTimeout !== null) clearTimeout(timers.accelerationTimeout); 
        timers.darkenInterval = null;
        timers.gameLoopInterval = null;
        timers.accelerationTimeout = null;
    }

    /** 停止遊戲循環並返回歡迎畫面 */
    function returnToSplashScreen() {
        clearTimers();
        resetGameState();
        UI.clickHint.classList.add('hidden');
        UI.accelerationMessage.classList.add('opacity-0', 'pointer-events-none');
        render(); 
    }

    /** 啟動遊戲 */
    function startGameLoop() {
        clearTimers();
        
        resetGameState(); 
        gameState.isGameRunning = true;
        gameState.gameStartTime = Date.now();
        
        // 1. 初始隨機變暗
        timers.darkenInterval = setInterval(randomlyDarkenHabit, DARKEN_INTERVAL_SLOW_MS);
        
        // 2. 設定 15 秒後加速
        timers.accelerationTimeout = setTimeout(accelerateGame, ACCELERATION_TIME_MS);

        // 3. 持續衰減
        timers.gameLoopInterval = setInterval(gameLoop, DECAY_INTERVAL_MS);

        render();
    }
    
    /** 遊戲結束 */
    function endGame() {
        if (gameState.isGameOver) return; 

        gameState.isGameOver = true;
        gameState.isGameRunning = false;
        clearTimers();
        
        // 確保最終分數顯示為 0
        gameState.score = 0; 

        UI.clickHint.classList.add('hidden');
        UI.accelerationMessage.classList.add('opacity-0', 'pointer-events-none'); 
        
        render(); // 渲染結束畫面和禁用按鈕
    }


    /** 顯示點擊提示框 */
    function showClickHint(targetElement) {
        const rect = targetElement.getBoundingClientRect();
        const dashboardRect = UI.dashboard.getBoundingClientRect(); 

        const top = rect.top - dashboardRect.top;
        const left = rect.left - dashboardRect.left + (rect.width / 2);

        UI.clickHint.style.top = `${top}px`;
        UI.clickHint.style.left = `${left}px`;
        UI.clickHint.style.transform = 'translate(-50%, calc(-100% - 10px))'; 

        UI.clickHint.classList.remove('hidden');
    }

    /** 初始化應用程式 (獲取 DOM 元素並綁定事件) */
    function initApp() {
        // 填充 UI 元素參考
        UI.dashboard = document.getElementById('dashboard');
        UI.scoreDisplay = document.getElementById('scoreDisplay');
        UI.progressBar = document.getElementById('progressBar');
        UI.gameOverOverlay = document.getElementById('gameOverOverlay'); 
        UI.restartButton = document.getElementById('restartButton'); 
        UI.clickHint = document.getElementById('clickHint');
        UI.splashScreen = document.getElementById('splashScreen');
        UI.startButton = document.getElementById('startButton');
        UI.accelerationMessage = document.getElementById('accelerationMessage');
        UI.backToHomeButton = document.getElementById('backToHomeButton');
        UI.checkinButtons = document.querySelectorAll('.checkin-button');

        // 獲取習慣元素並儲存在 habitDefinitions 中
        UI.checkinButtons.forEach(button => {
            if (habitDefinitions[button.id]) {
                habitDefinitions[button.id].element = button;
            }
        });

        // 設定固定的事件監聽器
        UI.startButton.onclick = startGameLoop;
        UI.backToHomeButton.onclick = returnToSplashScreen;
        UI.restartButton.onclick = startGameLoop; 
        
        // 初始狀態
        resetGameState();
        
        render(); 
    }

    // 啟動應用程式
    initApp();

</script>
